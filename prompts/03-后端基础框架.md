# 任务 03: 后端基础框架搭建

## 目标
搭建 Node.js 后端服务基础框架，包括 Express/Fastify 配置、数据库连接、中间件等。

## 执行步骤

### 1. 初始化 backend 包
```bash
cd packages/backend
pnpm init
```

### 2. 安装核心依赖
```bash
# 核心框架（二选一）
pnpm add express
# 或
pnpm add fastify

# 数据库
pnpm add mongoose      # MongoDB ODM
pnpm add ioredis       # Redis 客户端

# WebSocket
pnpm add socket.io

# 工具库
pnpm add dotenv        # 环境变量
pnpm add zod           # 数据验证
pnpm add winston       # 日志
pnpm add node-cron     # 定时任务
pnpm add compression   # 压缩
pnpm add helmet        # 安全
pnpm add cors          # CORS
pnpm add express-rate-limit  # 限流（express）

# 开发依赖
pnpm add -D typescript @types/node @types/express
pnpm add -D tsx        # TypeScript 执行器
pnpm add -D nodemon    # 热重载
```

### 3. 引用 shared 包
```bash
pnpm add @logadmin/shared@workspace:*
```

### 4. 配置 TypeScript
创建 `tsconfig.json`：
```json
{
  "extends": "../../tsconfig.base.json",
  "compilerOptions": {
    "outDir": "./dist",
    "rootDir": "./src",
    "module": "commonjs",
    "target": "ES2020",
    "esModuleInterop": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist", "tests"]
}
```

### 5. 创建配置系统

#### 5.1 环境变量配置 (`.env.example`)
```env
# 服务器配置
PORT=3000
HOST=0.0.0.0
NODE_ENV=development

# MongoDB
MONGODB_URI=mongodb://localhost:27017/logadmin
MONGODB_MAX_POOL_SIZE=10

# Redis
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=

# 日志存储
LOG_STORAGE_PATH=./logs
LOG_MAX_FILE_SIZE=1048576
LOG_RETENTION_DAYS=90

# 接收器
HTTP_RECEIVER_PORT=8080
HTTP_RECEIVER_MAX_BODY_SIZE=10mb

# WebSocket
WS_MAX_CONNECTIONS=1000
WS_PUSH_BATCH_SIZE=50
WS_PUSH_INTERVAL=100

# 安全
JWT_SECRET=your-secret-key
API_KEY_HEADER=X-API-Key
RATE_LIMIT_WINDOW_MS=60000
RATE_LIMIT_MAX_REQUESTS=1000
```

#### 5.2 配置加载器 (`src/config/index.ts`)
实现：
- 从环境变量加载配置
- 配置验证
- 默认值处理
- 类型安全的配置对象

#### 5.3 数据库配置 (`src/config/database.ts`)
实现：
- MongoDB 连接配置
- Redis 连接配置
- 连接池配置
- 重连策略

### 6. 创建数据库连接

#### 6.1 MongoDB 连接 (`src/database/mongodb.ts`)
实现：
- 连接初始化
- 连接事件监听
- 优雅断开
- 错误处理

#### 6.2 Redis 连接 (`src/database/redis.ts`)
实现：
- Redis 客户端初始化
- 发布/订阅模式支持
- 连接池管理
- 健康检查

### 7. 创建数据模型

#### 7.1 日志模型 (`src/models/Log.ts`)
定义 Mongoose Schema：
- LogEntry 字段定义
- 索引配置（deviceId + timestamp + level）
- 虚拟字段
- 实例方法和静态方法

#### 7.2 设备模型 (`src/models/Device.ts`)
定义 Mongoose Schema：
- Device 字段定义
- 唯一索引（id, apiKey）
- 设备状态更新方法
- 查询方法

#### 7.3 用户模型 (`src/models/User.ts`) - 可选
定义基础用户模型，用于后台管理。

### 8. 创建中间件

#### 8.1 错误处理中间件 (`src/middleware/errorHandler.ts`)
实现：
- 统一错误处理
- 错误日志记录
- 错误响应格式化
- 开发/生产环境区分

#### 8.2 认证中间件 (`src/middleware/auth.ts`)
实现：
- API Key 验证
- JWT Token 验证
- 设备认证
- 权限检查

#### 8.3 验证中间件 (`src/middleware/validation.ts`)
实现：
- 请求体验证（使用 Zod）
- 参数验证
- 查询参数验证
- 验证错误处理

#### 8.4 日志中间件 (`src/middleware/logger.ts`)
实现：
- 请求日志
- 响应日志
- 性能监控
- 错误日志

#### 8.5 限流中间件 (`src/middleware/rateLimit.ts`)
实现：
- 基于 IP 的限流
- 基于设备 ID 的限流
- Redis 存储
- 超限响应

### 9. 创建工具函数

#### 9.1 系统日志工具 (`src/utils/logger.ts`)
实现 Winston 配置：
- 多级别日志（error, warn, info, debug）
- 文件输出
- 控制台输出
- 日志格式化
- 日志轮转

#### 9.2 文件管理工具 (`src/utils/fileManager.ts`)
实现：
- 创建日志文件
- 文件大小检查
- 文件切割
- 目录管理

#### 9.3 压缩工具 (`src/utils/compression.ts`)
实现：
- Gzip 压缩
- 解压缩
- 批量压缩

#### 9.4 响应工具 (`src/utils/response.ts`)
实现：
- 统一成功响应
- 统一错误响应
- 分页响应构建

### 10. 创建应用入口

#### 10.1 Express 应用 (`src/app.ts`)
配置：
- 中间件注册
- 路由注册
- 错误处理
- 健康检查端点

#### 10.2 服务器启动 (`src/server.ts`)
实现：
- 数据库连接
- 服务器启动
- 优雅关闭
- 信号处理

### 11. 配置 package.json
```json
{
  "name": "@logadmin/backend",
  "version": "1.0.0",
  "scripts": {
    "dev": "nodemon --exec tsx src/server.ts",
    "build": "tsc",
    "start": "node dist/server.js",
    "test": "jest"
  },
  "engines": {
    "node": ">=18.0.0"
  }
}
```

### 12. 创建 nodemon 配置
`nodemon.json`：
```json
{
  "watch": ["src"],
  "ext": "ts,json",
  "ignore": ["src/**/*.spec.ts"],
  "exec": "tsx src/server.ts"
}
```

## 核心代码示例

### 配置加载器
```typescript
import { z } from 'zod'

const configSchema = z.object({
  port: z.number().default(3000),
  host: z.string().default('0.0.0.0'),
  nodeEnv: z.enum(['development', 'production', 'test']).default('development'),
  mongodb: z.object({
    uri: z.string(),
    maxPoolSize: z.number().default(10)
  }),
  redis: z.object({
    host: z.string().default('localhost'),
    port: z.number().default(6379),
    password: z.string().optional()
  })
})

export type Config = z.infer<typeof configSchema>

export function loadConfig(): Config {
  // 实现配置加载逻辑
}
```

### MongoDB 连接
```typescript
import mongoose from 'mongoose'
import { logger } from '../utils/logger'

export async function connectMongoDB(uri: string) {
  try {
    await mongoose.connect(uri, {
      maxPoolSize: 10,
      serverSelectionTimeoutMS: 5000
    })
    logger.info('MongoDB connected')
  } catch (error) {
    logger.error('MongoDB connection error:', error)
    throw error
  }
}
```

### 日志模型
```typescript
import { Schema, model } from 'mongoose'
import { LogEntry, LogLevel } from '@logadmin/shared'

const logSchema = new Schema<LogEntry>({
  id: { type: String, required: true, unique: true },
  deviceId: { type: String, required: true, index: true },
  timestamp: { type: Date, required: true, index: true },
  level: { type: String, enum: Object.values(LogLevel), required: true, index: true },
  message: { type: String, required: true },
  tags: [String],
  metadata: Schema.Types.Mixed,
  source: String,
  traceId: String,
  userId: String,
  sessionId: String,
  receivedAt: { type: Date, required: true },
  processedAt: Date
})

// 复合索引
logSchema.index({ deviceId: 1, timestamp: -1, level: 1 })

export const LogModel = model<LogEntry>('Log', logSchema)
```

### 错误处理中间件
```typescript
import { Request, Response, NextFunction } from 'express'
import { logger } from '../utils/logger'

export function errorHandler(
  err: Error,
  req: Request,
  res: Response,
  next: NextFunction
) {
  logger.error('Error:', err)
  
  res.status(500).json({
    success: false,
    message: process.env.NODE_ENV === 'production' 
      ? 'Internal server error' 
      : err.message,
    timestamp: Date.now()
  })
}
```

## 验收标准
- [ ] 服务器可以正常启动
- [ ] MongoDB 连接成功
- [ ] Redis 连接成功
- [ ] 中间件正常工作
- [ ] 错误处理完善
- [ ] 热重载功能正常
- [ ] 健康检查端点响应正常（GET /health）

## 预期产出文件
```
packages/backend/
├── src/
│   ├── config/
│   │   ├── index.ts
│   │   └── database.ts
│   ├── database/
│   │   ├── mongodb.ts
│   │   └── redis.ts
│   ├── models/
│   │   ├── Log.ts
│   │   ├── Device.ts
│   │   └── User.ts
│   ├── middleware/
│   │   ├── errorHandler.ts
│   │   ├── auth.ts
│   │   ├── validation.ts
│   │   ├── logger.ts
│   │   └── rateLimit.ts
│   ├── utils/
│   │   ├── logger.ts
│   │   ├── fileManager.ts
│   │   ├── compression.ts
│   │   └── response.ts
│   ├── app.ts
│   └── server.ts
├── .env.example
├── nodemon.json
├── package.json
└── tsconfig.json
```

## 测试方法
```bash
# 启动 MongoDB 和 Redis (Docker)
docker run -d -p 27017:27017 mongo:latest
docker run -d -p 6379:6379 redis:latest

# 复制环境变量
cp .env.example .env

# 启动开发服务器
pnpm dev

# 测试健康检查
curl http://localhost:3000/health
```

## 下一步
完成后继续执行 `04-HTTP接收器实现.md`
