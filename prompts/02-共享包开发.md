# 任务 02: 共享包 (Shared) 开发

## 目标
创建 shared 包，定义整个系统使用的共享类型、常量和工具函数。

## 执行步骤

### 1. 初始化 shared 包
在 `packages/shared` 目录下：
```bash
cd packages/shared
pnpm init
```

### 2. 安装依赖
```bash
pnpm add -D typescript @types/node
```

### 3. 配置 TypeScript
创建 `tsconfig.json`，继承根配置：
```json
{
  "extends": "../../tsconfig.base.json",
  "compilerOptions": {
    "outDir": "./dist",
    "rootDir": "./src"
  },
  "include": ["src/**/*"]
}
```

### 4. 创建类型定义

#### 4.1 日志类型 (`src/types/log.types.ts`)
定义：
- `LogLevel` 枚举：DEBUG, INFO, WARN, ERROR, FATAL
- `LogEntry` 接口：完整的日志记录结构
- `LogQueryParams` 接口：查询参数
- `LogStatistics` 接口：统计数据

#### 4.2 设备类型 (`src/types/device.types.ts`)
定义：
- `DeviceStatus` 枚举：online, offline
- `Device` 接口：设备信息结构
- `DeviceConfig` 接口：设备配置
- `DeviceStatistics` 接口：设备统计

#### 4.3 接收器类型 (`src/types/receiver.types.ts`)
定义：
- `ReceiverType` 枚举：HTTP, TCP, UDP, Syslog 等
- `IReceiver` 接口：接收器基础接口
- `ReceiverConfig` 接口：接收器配置
- `ReceiverStatus` 接口：接收器状态

#### 4.4 API 类型 (`src/types/api.types.ts`)
定义：
- `ApiResponse<T>` 接口：统一响应格式
- `PaginatedResponse<T>` 接口：分页响应
- `ErrorResponse` 接口：错误响应

#### 4.5 WebSocket 事件类型 (`src/types/websocket.types.ts`)
定义：
- `WebSocketEvent` 枚举：所有 WebSocket 事件
- `LogSubscription` 接口：日志订阅配置
- 各种事件的 Payload 类型

### 5. 创建常量定义

#### 5.1 日志级别 (`src/constants/logLevels.ts`)
定义：
- 日志级别常量
- 日志级别权重
- 日志级别颜色映射

#### 5.2 事件名称 (`src/constants/events.ts`)
定义：
- WebSocket 事件名称
- 系统事件名称

#### 5.3 错误码 (`src/constants/errorCodes.ts`)
定义：
- 系统错误码
- 业务错误码
- HTTP 状态码映射

#### 5.4 配置常量 (`src/constants/config.ts`)
定义：
- 默认配置值
- 限制常量（文件大小、并发数等）
- 时间常量

### 6. 创建工具函数

#### 6.1 验证函数 (`src/utils/validation.ts`)
实现：
- `isValidLogLevel()`: 验证日志级别
- `isValidDeviceId()`: 验证设备 ID
- `isValidTimestamp()`: 验证时间戳
- `sanitizeInput()`: 输入清洗

#### 6.2 格式化函数 (`src/utils/format.ts`)
实现：
- `formatLogEntry()`: 格式化日志条目
- `formatTimestamp()`: 格式化时间戳
- `formatFileSize()`: 格式化文件大小
- `escapeHtml()`: HTML 转义

#### 6.3 日期工具 (`src/utils/date.ts`)
实现：
- `getDateString()`: 获取日期字符串（YYYYMMDD）
- `getArchivePath()`: 生成归档路径
- `parseLogTimestamp()`: 解析日志时间戳

### 7. 创建统一导出
在 `src/index.ts` 中统一导出所有类型、常量和工具函数。

### 8. 配置 package.json
```json
{
  "name": "@logadmin/shared",
  "version": "1.0.0",
  "main": "./dist/index.js",
  "types": "./dist/index.d.ts",
  "scripts": {
    "build": "tsc",
    "dev": "tsc --watch"
  }
}
```

## 代码示例

### LogLevel 枚举
```typescript
export enum LogLevel {
  DEBUG = 'DEBUG',
  INFO = 'INFO',
  WARN = 'WARN',
  ERROR = 'ERROR',
  FATAL = 'FATAL'
}

export const LOG_LEVEL_WEIGHT: Record<LogLevel, number> = {
  [LogLevel.DEBUG]: 0,
  [LogLevel.INFO]: 1,
  [LogLevel.WARN]: 2,
  [LogLevel.ERROR]: 3,
  [LogLevel.FATAL]: 4
}
```

### LogEntry 接口
```typescript
export interface LogEntry {
  id: string
  deviceId: string
  timestamp: Date
  level: LogLevel
  message: string
  tags?: string[]
  metadata?: Record<string, any>
  source?: string
  traceId?: string
  userId?: string
  sessionId?: string
  receivedAt: Date
  processedAt?: Date
}
```

### ApiResponse 接口
```typescript
export interface ApiResponse<T = any> {
  success: boolean
  data?: T
  message?: string
  timestamp: number
}

export interface PaginatedResponse<T> extends ApiResponse<T[]> {
  pagination: {
    page: number
    pageSize: number
    total: number
    totalPages: number
  }
}
```

## 验收标准
- [ ] 所有类型定义完整且类型安全
- [ ] 常量定义清晰，有注释说明
- [ ] 工具函数有单元测试（可选）
- [ ] 编译成功，无 TypeScript 错误
- [ ] 导出正确，可被其他包引用

## 预期产出文件
```
packages/shared/
├── src/
│   ├── types/
│   │   ├── log.types.ts
│   │   ├── device.types.ts
│   │   ├── receiver.types.ts
│   │   ├── api.types.ts
│   │   ├── websocket.types.ts
│   │   └── index.ts
│   ├── constants/
│   │   ├── logLevels.ts
│   │   ├── events.ts
│   │   ├── errorCodes.ts
│   │   ├── config.ts
│   │   └── index.ts
│   ├── utils/
│   │   ├── validation.ts
│   │   ├── format.ts
│   │   ├── date.ts
│   │   └── index.ts
│   └── index.ts
├── package.json
└── tsconfig.json
```

## 使用示例
其他包中引用：
```typescript
import { LogLevel, LogEntry, ApiResponse } from '@logadmin/shared'

const log: LogEntry = {
  id: '123',
  deviceId: 'device-001',
  timestamp: new Date(),
  level: LogLevel.INFO,
  message: 'Test log',
  receivedAt: new Date()
}
```

## 下一步
完成后继续执行 `03-后端基础框架.md`
