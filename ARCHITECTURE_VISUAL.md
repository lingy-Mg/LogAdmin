# LogAdmin 架构可视化

## 📊 系统架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                            客户端层                                   │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                     Frontend (Vue 3)                         │   │
│  │  - 日志实时展示                                               │   │
│  │  - 设备管理界面                                               │   │
│  │  - 过滤和搜索                                                 │   │
│  └──────────────────────┬──────────────────────────────────────┘   │
└─────────────────────────┼───────────────────────────────────────────┘
                          │
                          │ HTTP + WebSocket
                          │
┌─────────────────────────▼───────────────────────────────────────────┐
│                          服务器层                                     │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │              HTTP Server (Express + Socket.IO)              │    │
│  │  - RESTful API 接口                                         │    │
│  │  - WebSocket 实时通信                                       │    │
│  │  - 静态文件服务                                             │    │
│  └─────────────────────┬──────────────────────────────────────┘    │
│                        │                                            │
│  ┌─────────────────────▼──────────────────────────────────────┐    │
│  │                    Routes Layer                             │    │
│  │  ┌──────────────┐           ┌──────────────┐              │    │
│  │  │ logRoutes.js │           │deviceRoutes.js│              │    │
│  │  └──────┬───────┘           └──────┬────────┘              │    │
│  └─────────┼──────────────────────────┼───────────────────────┘    │
│            │                          │                             │
│  ┌─────────▼──────────────────────────▼───────────────────────┐    │
│  │                    Services Layer                           │    │
│  │  ┌──────────────┐  ┌──────────────┐  ┌─────────────────┐  │    │
│  │  │ LogService   │  │DeviceService │  │PersistenceService│  │    │
│  │  │              │  │              │  │                 │  │    │
│  │  │ - 日志管理    │  │ - 设备别名   │  │ - 文件读写      │  │    │
│  │  │ - 查询过滤    │  │ - 设备列表   │  │ - 延迟写入      │  │    │
│  │  │ - 数量限制    │  │ - 批量操作   │  │ - 优雅关闭      │  │    │
│  │  └──────┬───────┘  └──────┬───────┘  └────────┬────────┘  │    │
│  └─────────┼──────────────────┼──────────────────┼───────────┘    │
│            │                  │                  │                 │
│  ┌─────────▼──────────────────▼──────────────────▼───────────┐    │
│  │                     Models Layer                            │    │
│  │  ┌──────────────────────────────────────────────────────┐  │    │
│  │  │                    Log Model                         │  │    │
│  │  │  - 数据结构定义                                       │  │    │
│  │  │  - 数据验证                                           │  │    │
│  │  │  - ID/时间戳生成                                      │  │    │
│  │  └──────────────────────────────────────────────────────┘  │    │
│  └─────────────────────────────────────────────────────────────┘    │
└─────────────────────────┬───────────────────────────────────────────┘
                          │
                          │ 文件系统
                          │
┌─────────────────────────▼───────────────────────────────────────────┐
│                         持久化层                                      │
│  ┌────────────────────┐          ┌───────────────────────┐          │
│  │  logs-data.json    │          │ device-aliases.json   │          │
│  │                    │          │                       │          │
│  │  - 日志历史数据     │          │  - 设备别名映射        │          │
│  │  - 延迟5分钟写入    │          │  - 实时同步           │          │
│  └────────────────────┘          └───────────────────────┘          │
└─────────────────────────────────────────────────────────────────────┘
```

## 🔄 请求流程图

### 日志接收流程

```
┌──────────┐
│外部设备  │
└────┬─────┘
     │ POST /api/logs
     │ { deviceId, level, message }
     ▼
┌────────────────┐
│  logRoutes.js  │ ─────► 验证请求
└────┬───────────┘
     │ 调用服务
     ▼
┌────────────────┐
│  LogService    │ ─────► 创建 Log 对象
│  .addLog()     │ ─────► 添加到内存列表
└────┬───────────┘ ─────► 限制数量 (1000)
     │
     ├─────────────────┬────────────────────┐
     │                 │                    │
     ▼                 ▼                    ▼
┌──────────┐    ┌─────────────┐    ┌──────────────────┐
│WebSocket │    │Persistence  │    │返回响应          │
│推送      │    │Service      │    │{ success, data } │
└──────────┘    │.schedule()  │    └──────────────────┘
                └─────────────┘
                      │
                      │ 5分钟后
                      ▼
                ┌─────────────┐
                │logs-data.json│
                │写入文件      │
                └─────────────┘
```

### 设备别名设置流程

```
┌──────────┐
│前端界面  │
└────┬─────┘
     │ POST /api/devices/alias
     │ { deviceId, alias }
     ▼
┌────────────────┐
│deviceRoutes.js │ ─────► 验证请求
└────┬───────────┘
     │ 调用服务
     ▼
┌────────────────┐
│DeviceService   │ ─────► 设置别名
│.setAlias()     │ ─────► 更新内存映射
└────┬───────────┘
     │
     ├─────────────────┬────────────────────┐
     │                 │                    │
     ▼                 ▼                    ▼
┌──────────┐    ┌─────────────┐    ┌──────────────────┐
│WebSocket │    │Persistence  │    │返回响应          │
│广播      │    │Service      │    │{ success, data } │
│所有客户端│    │.schedule()  │    └──────────────────┘
└──────────┘    └─────────────┘
                      │
                      │ 5分钟后
                      ▼
                ┌──────────────────┐
                │device-aliases.json│
                │写入文件           │
                └──────────────────┘
```

### 日志查询流程

```
┌──────────┐
│前端界面  │
└────┬─────┘
     │ GET /api/logs?level=INFO&deviceId=xxx&keyword=xxx
     ▼
┌────────────────┐
│  logRoutes.js  │ ─────► 解析查询参数
└────┬───────────┘
     │ 调用服务
     ▼
┌────────────────┐
│  LogService    │ ─────► 过滤日志（级别）
│  .queryLogs()  │ ─────► 过滤日志（设备）
└────┬───────────┘ ─────► 过滤日志（关键词）
     │                  ─────► 限制数量
     ▼
┌──────────────────┐
│返回过滤后的日志  │
│{ success, data, │
│  total }        │
└──────────────────┘
```

## 🧩 模块依赖关系

```
                    ┌──────────────┐
                    │  index.js    │ (应用入口)
                    └──────┬───────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
        ▼                  ▼                  ▼
┌──────────────┐   ┌──────────────┐   ┌──────────────┐
│   app.js     │   │   config/    │   │  Services    │
│  Express配置  │   │   配置参数    │   │  三个服务     │
└──────────────┘   └──────────────┘   └──────┬───────┘
                                              │
                           ┌──────────────────┼──────────────────┐
                           │                  │                  │
                           ▼                  ▼                  ▼
                   ┌──────────────┐   ┌──────────────┐   ┌──────────────┐
                   │  LogService  │   │DeviceService │   │Persistence   │
                   │              │   │              │   │Service       │
                   └──────┬───────┘   └──────┬───────┘   └──────┬───────┘
                          │                  │                  │
            ┌─────────────┼──────────────────┘                  │
            │             │                                     │
            ▼             ▼                                     ▼
    ┌──────────────┐ ┌──────────────┐                 ┌──────────────┐
    │ logRoutes.js │ │deviceRoutes  │                 │  文件系统     │
    └──────┬───────┘ └──────┬───────┘                 │  JSON 文件    │
           │                │                         └──────────────┘
           └────────┬───────┘
                    │
                    ▼
            ┌──────────────┐
            │  Express App │
            │  HTTP + WS   │
            └──────────────┘
```

## 📦 分层架构详解

```
┌────────────────────────────────────────────────────────────────┐
│  Presentation Layer (表现层)                                    │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  - Express Routes                                        │  │
│  │  - HTTP 端点定义                                          │  │
│  │  - 请求验证和响应格式化                                    │  │
│  └──────────────────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────────────────┘
                              ▼
┌────────────────────────────────────────────────────────────────┐
│  Business Logic Layer (业务逻辑层)                              │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  - LogService (日志管理)                                  │  │
│  │  - DeviceService (设备管理)                               │  │
│  │  - PersistenceService (持久化管理)                        │  │
│  │  - 核心业务逻辑                                            │  │
│  │  - 数据操作和转换                                          │  │
│  └──────────────────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────────────────┘
                              ▼
┌────────────────────────────────────────────────────────────────┐
│  Data Access Layer (数据访问层)                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  - 文件系统读写                                            │  │
│  │  - JSON 序列化/反序列化                                    │  │
│  │  - 数据持久化                                              │  │
│  └──────────────────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────────────────┘
                              ▼
┌────────────────────────────────────────────────────────────────┐
│  Data Layer (数据层)                                            │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  - logs-data.json                                        │  │
│  │  - device-aliases.json                                   │  │
│  └──────────────────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────────────────┘
```

## 🔌 WebSocket 通信架构

```
┌─────────────────────────────────────────────────────────────┐
│                         客户端                                │
│                                                               │
│  ┌─────────────────────────────────────────────────────┐    │
│  │              Socket.IO Client                        │    │
│  └───────────────────┬─────────────────────────────────┘    │
└────────────────────┼─────────────────────────────────────────┘
                     │
                     │ WebSocket Connection
                     │
┌────────────────────▼─────────────────────────────────────────┐
│                      Socket.IO Server                         │
│                                                               │
│  ┌─────────────────────────────────────────────────────┐    │
│  │            socketHandler.js                          │    │
│  │                                                      │    │
│  │  连接事件:                                            │    │
│  │  ├─ connection    → 发送历史日志                      │    │
│  │  │                 → 发送设备别名                     │    │
│  │  └─ disconnect    → 清理连接                         │    │
│  │                                                      │    │
│  │  推送事件:                                            │    │
│  │  ├─ log:new              (新日志)                    │    │
│  │  ├─ log:history          (历史日志)                  │    │
│  │  ├─ log:clear            (清空通知)                  │    │
│  │  ├─ device:alias:update  (单个别名更新)              │    │
│  │  ├─ device:aliases:update(批量更新)                  │    │
│  │  └─ device:aliases       (所有别名)                  │    │
│  └─────────────────────────────────────────────────────┘    │
└───────────────────────────────────────────────────────────────┘
```

## 🎯 设计模式应用

### 1. 分层架构模式 (Layered Architecture)
```
Routes → Services → Models → Data
清晰的职责分离，低耦合高内聚
```

### 2. 依赖注入模式 (Dependency Injection)
```javascript
createLogRoutes(logService, persistenceService, io)
// 通过参数传递依赖，便于测试和替换
```

### 3. 单例模式 (Singleton)
```javascript
const logService = new LogService()
// 全局唯一实例，状态集中管理
```

### 4. 观察者模式 (Observer)
```javascript
io.emit('log:new', log)
// 事件驱动，解耦发布者和订阅者
```

### 5. 工厂模式 (Factory)
```javascript
class Log {
  constructor(data) { /* 自动生成 ID 和时间戳 */ }
}
```

## 🔄 数据流动

```
外部日志 ──┐
           │
           ├──► HTTP API ──► Routes ──► Services ──► Memory
           │                              │            │
前端操作 ──┘                              │            │
                                         ▼            │
                                   WebSocket          │
                                   实时推送 ──────────┤
                                                      │
                                   定时器(5分钟)      │
                                         │            │
                                         ▼            ▼
                                   Persistence ──► JSON Files
```

## 📊 性能优化策略

```
┌─────────────────────────────────────────────────────────────┐
│                      性能优化点                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. 延迟写入 (Debounce)                                      │
│     ┌──────────────────────────────────────┐               │
│     │  数据变更 → 设置定时器(5分钟)        │               │
│     │  新变更到来 → 重置定时器              │               │
│     │  定时器触发 → 批量写入文件            │               │
│     └──────────────────────────────────────┘               │
│     ✅ 减少磁盘 I/O 次数                                     │
│     ✅ 提升系统性能                                          │
│                                                             │
│  2. 内存限制                                                 │
│     ┌──────────────────────────────────────┐               │
│     │  最多保存 1000 条日志                 │               │
│     │  超出自动删除最旧的                   │               │
│     └──────────────────────────────────────┘               │
│     ✅ 防止内存溢出                                          │
│                                                             │
│  3. WebSocket 推送                                           │
│     ┌──────────────────────────────────────┐               │
│     │  事件驱动，实时推送                   │               │
│     │  避免客户端轮询                       │               │
│     └──────────────────────────────────────┘               │
│     ✅ 降低服务器负载                                        │
│     ✅ 提升实时性                                            │
│                                                             │
│  4. 异步非阻塞                                               │
│     ┌──────────────────────────────────────┐               │
│     │  所有 I/O 操作异步执行                │               │
│     │  不阻塞主线程                         │               │
│     └──────────────────────────────────────┘               │
│     ✅ 高并发处理能力                                        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 🎨 架构优势总结

| 优势 | 说明 |
|------|------|
| 🧩 **模块化** | 每个模块职责单一，易于理解和维护 |
| 🧪 **可测试性** | 服务层独立，便于编写单元测试 |
| 🔧 **可扩展性** | 新增功能只需添加新模块，不影响现有代码 |
| 📖 **可读性** | 目录结构清晰，代码组织合理 |
| ⚡ **高性能** | 延迟写入、内存限制等优化策略 |
| 🔒 **可靠性** | 优雅关闭机制，确保数据不丢失 |
| 🔄 **可维护性** | 分层架构，便于定位和修复问题 |
| 🎯 **灵活性** | 配置集中管理，易于调整参数 |
